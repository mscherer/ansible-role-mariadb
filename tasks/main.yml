---
# default to mariadb, see vars/main.yml
- set_fact: rdbms=mysql
  when: (ansible_distribution == 'RedHat' or ansible_distribution == 'CentOS') and ansible_distribution_major_version <= 6

# fix once https://github.com/ansible/ansible/pull/17782
- set_fact: rdbms_root_pw="{{ lookup('password', '~/' + rdbms + '_root_password length=15') }}"
  no_log: True

- include_vars: "{{ rdbms }}.yml"

- name: Install database packages
  package:
    name: "{{ item }}"
    state: present
  with_items:
  - "{{ rdbms_package }}"
  - MySQL-python

- name: Deploy mariadb configuration
  template:
    src: custom.cnf
    dest: /etc/my.cnf.d/custom.cnf
  notify: restart mariadb
  when: rdbms == 'mariadb'

- name: Deploy mysql configuration
  template:
    src: my.server.cnf
    dest: /etc/my.cnf
  notify: restart mysqld
  when: rdbms == 'mysqld'

- name: Set database admin password
  mysql_user:
    name: root
    password: "{{ rdbms_root_pw }}"

- name: Deploy the client configuration
  template:
    src: my.client.cnf
    dest: /root/.my.cnf
    mode: 600
    owner: root
    group: root

- name: "Start the {{ rdbms_service }} service"
  service:
    name: "{{ rdbms_service }}"
    enabled: yes
    state: started

- name: "Deploy back script for {{ rdbms }}"
  copy:
    mode: 0755
    src: dump_db.sh
    dest: /usr/local/bin/dump_{{ rdbms }}.sh

- name: "Deploy cronjob for {{ rdbms }} backup"
  cron:
    minute: 15
    hour: 4
    name: "backup {{ rdbms }}"
    job: /usr/local/bin/dump_{{ rdbms }}.sh
